<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDB Marketing Division - Leave Tracker Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0f4c81;
            --primary-light: #e0e7ff;
            --secondary: #64748b;
            --danger: #ef4444;
            --success: #10b981;
            --warning: #f59e0b; 
            --lieu: #8b5cf6;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #0f172a;
            --border: #e2e8f0;
            --radius: 12px;
        }

        * { box-sizing: border-box; }
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px;
            line-height: 1.6;
        }

        .container { max-width: 1440px; margin: 0 auto; }
        
        /* Headers */
        .header-section { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px; 
            background: white; 
            padding: 24px 32px; 
            border-radius: var(--radius); 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border: 1px solid var(--border);
        }
        .header-left h1 { color: var(--primary); margin: 0; font-size: 1.4rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 800; }
        .header-left h2 { color: var(--secondary); margin: 4px 0 0 0; font-weight: 500; font-size: 0.95rem; }
        .year-badge { background: var(--primary); color: white; padding: 6px 16px; border-radius: 30px; font-size: 0.85rem; font-weight: 700; }

        /* Stats Grid */
        .stats-row { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; 
            margin-bottom: 24px; 
        }
        .stat-card { 
            background: white; 
            padding: 24px; 
            border-radius: var(--radius); 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            border-left: 5px solid var(--primary);
            transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-2px); }
        .stat-label { font-size: 0.7rem; font-weight: 800; color: var(--secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; display: block; }
        .stat-value { font-size: 2rem; font-weight: 800; color: var(--primary); line-height: 1; }

        /* Layout Grid */
        .main-grid { display: grid; grid-template-columns: 380px 1fr; gap: 24px; align-items: start; }
        @media (max-width: 1150px) { .main-grid { grid-template-columns: 1fr; } }

        /* Panel Styling */
        .panel { 
            background: var(--card-bg); 
            padding: 28px; 
            border-radius: var(--radius); 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); 
            margin-bottom: 24px; 
            border: 1px solid var(--border);
        }
        .panel-title { 
            font-size: 0.85rem; 
            font-weight: 800; 
            margin: 0 0 20px 0; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            color: var(--primary); 
            text-transform: uppercase; 
            border-bottom: 2px solid var(--primary-light); 
            padding-bottom: 12px; 
        }

        /* Form Controls */
        .form-group { margin-bottom: 18px; }
        label { font-size: 0.7rem; font-weight: 700; margin-bottom: 8px; color: var(--secondary); text-transform: uppercase; display: block; }
        input, select { 
            width: 100%; 
            padding: 12px; 
            border: 1.5px solid var(--border); 
            border-radius: 10px; 
            font-size: 14px; 
            font-family: inherit;
            transition: all 0.2s; 
            background: #fff;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }
        
        /* Buttons */
        button { 
            cursor: pointer; 
            padding: 12px 20px; 
            border: none; 
            border-radius: 10px; 
            font-weight: 700; 
            transition: all 0.2s; 
            font-size: 14px; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 8px; 
            font-family: inherit;
        }
        .btn-primary { background-color: var(--primary); color: white; width: 100%; }
        .btn-primary:hover { background-color: #0c3d69; transform: translateY(-1px); }
        .btn-success { background-color: var(--success); color: white; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-outline { background: white; border: 1.5px solid var(--border); color: var(--secondary); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); background: #f8fafc; }

        /* Table Design */
        .table-container { 
            background: white; 
            border-radius: var(--radius); 
            overflow: hidden; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            border: 1px solid var(--border); 
        }
        table { width: 100%; border-collapse: collapse; }
        th { 
            background-color: #f8fafc; 
            text-align: left; 
            padding: 16px 20px; 
            font-size: 0.65rem; 
            font-weight: 800; 
            text-transform: uppercase; 
            color: var(--secondary); 
            letter-spacing: 0.05em; 
            border-bottom: 2px solid var(--border); 
        }
        td { padding: 18px 20px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; font-size: 0.85rem; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #fcfdfe; }
        
        /* Badges & Progress */
        .bal-badge { display: flex; flex-direction: column; align-items: center; min-width: 75px; }
        .bal-val { font-weight: 800; font-size: 0.95rem; }
        .bal-lbl { font-size: 0.55rem; font-weight: 700; opacity: 0.6; text-transform: uppercase; margin-top: 2px; }
        .progress-bg { height: 6px; background: #e2e8f0; border-radius: 10px; overflow: hidden; margin-top: 6px; width: 100%; }
        .progress-fill { height: 100%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }

        .status-low { color: var(--danger); }
        .status-low-fill { background-color: var(--danger); }
        .status-ok { color: var(--success); }
        .status-ok-fill { background-color: var(--success); }
        .status-normal { color: var(--primary); }
        .status-normal-fill { background-color: var(--primary); }
        .status-lieu { color: var(--lieu); }
        .status-lieu-fill { background-color: var(--lieu); }

        /* Modal Overlay */
        .modal-overlay { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(15, 23, 42, 0.7); 
            backdrop-filter: blur(6px); 
            z-index: 1000; 
            justify-content: center; 
            align-items: center; 
            animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .modal-content { 
            background: white; 
            width: 95%; 
            max-width: 800px; 
            border-radius: 20px; 
            padding: 32px; 
            max-height: 90vh; 
            overflow-y: auto; 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
        }
        .close-modal { 
            position: absolute; top: 20px; right: 20px; 
            background: #f1f5f9; border: none; font-size: 24px; 
            width: 40px; height: 40px; border-radius: 50%; 
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }

        /* Notifications (Toast) */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; }
        .toast { 
            padding: 16px 24px; border-radius: 12px; background: white; color: var(--text); 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border-left: 6px solid var(--primary);
            min-width: 300px; display: flex; align-items: center; justify-content: space-between;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Search Bar */
        .search-wrapper { position: relative; margin-bottom: 20px; }
        .search-input { padding-left: 44px; height: 50px; background: white; border-radius: 12px; border: 1.5px solid var(--border); }
        .search-icon { position: absolute; left: 16px; top: 15px; color: var(--secondary); pointer-events: none; }

        /* Tags */
        .tag { padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; }
        .tag-annual { background: #dbeafe; color: #1e40af; }
        .tag-casual { background: #fef3c7; color: #92400e; }
        .tag-medical { background: #fee2e2; color: #991b1b; }
        .tag-preAnnual { background: #f3e8ff; color: #6b21a8; }
        .tag-short { background: #ecfdf5; color: #065f46; }
        .tag-lieu-earn { background: #ede9fe; color: #5b21b6; }
        .tag-lieu-take { background: #fdf4ff; color: #86198f; }

        .history-item { 
            border: 1px solid var(--border); 
            margin-bottom: 10px; 
            padding: 14px; 
            border-radius: 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }

        /* Simple Confirmation Dialog Styling */
        .confirm-dialog { max-width: 400px; text-align: center; }
        .confirm-actions { display: flex; gap: 12px; margin-top: 24px; justify-content: center; }

        /* Lieu Summary Card */
        .lieu-summary-card {
            background: #f5f3ff;
            border: 1px solid #ddd6fe;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .lieu-summary-stat h4 { margin: 0; font-size: 0.65rem; text-transform: uppercase; color: #6d28d9; letter-spacing: 0.05em; }
        .lieu-summary-stat p { margin: 4px 0 0 0; font-size: 1.25rem; font-weight: 800; color: #5b21b6; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div class="container">
    <div class="header-section">
        <div class="header-left">
            <h1>Industrial Development Board</h1>
            <h2>Marketing Division ‚Äî Staff Leave Management</h2>
        </div>
        <div class="header-right">
            <span class="year-badge">System Active: <span id="displayYear">2025</span></span>
        </div>
    </div>

    <div class="stats-row">
        <div class="stat-card">
            <span class="stat-label">Registered Staff</span>
            <span class="stat-value" id="statStaffCount">0</span>
        </div>
        <div class="stat-card" style="border-left-color: var(--success);">
            <span class="stat-label">Leaves Logged</span>
            <span class="stat-value" id="statTotalLeaves">0</span>
        </div>
        <div class="stat-card" style="border-left-color: var(--lieu);">
            <span class="stat-label">Total Lieu Earned</span>
            <span class="stat-value" id="statTotalLieu">0</span>
        </div>
        <div class="stat-card" style="border-left-color: var(--danger);">
            <span class="stat-label">Balance Warnings</span>
            <span class="stat-value" id="statLowBalance">0</span>
        </div>
    </div>

    <div class="main-grid">
        <div class="side-panels">
            <!-- Alerts Panel -->
            <div class="panel" id="alertsPanel" style="display: none; border-color: #fee2e2; background: #fffcfc;">
                <h3 class="panel-title" style="color: var(--danger); border-bottom-color: #fee2e2;">‚ö†Ô∏è Low Balances</h3>
                <div id="alertsList"></div>
            </div>

            <!-- Add Profile Panel -->
            <div class="panel">
                <h3 class="panel-title">Add New Staff Profile</h3>
                <form id="addStaffForm" onsubmit="addStaff(event)">
                    <div class="form-group">
                        <label>EPF Number</label>
                        <input type="text" id="epf" required placeholder="e.g. 1044">
                    </div>
                    <div class="form-group">
                        <label>Staff Full Name</label>
                        <input type="text" id="name" required placeholder="Enter full name">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Annual</label>
                            <input type="number" id="annualLimit" required value="14" step="0.5">
                        </div>
                        <div class="form-group">
                            <label>Casual</label>
                            <input type="number" id="casualLimit" required value="7" step="0.5">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div class="form-group">
                            <label>Medical</label>
                            <input type="number" id="medicalLimit" required value="14" step="0.5">
                        </div>
                        <div class="form-group)
                            <label>Pre-Annual</label>
                            <input type="number" id="preAnnualLimit" required value="2" step="0.5">
                        </div>
                    </div>
                    <button type="submit" class="btn-primary" style="margin-top: 10px;">Create Profile</button>
                </form>
            </div>

            <!-- Database Panel -->
            <div class="panel">
                <h3 class="panel-title">Administration</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn-outline" onclick="backupData()">üíæ Export JSON Backup</button>
                    <button class="btn-outline" onclick="document.getElementById('restoreInput').click()">üìÇ Restore JSON Data</button>
                    <button class="btn-success" onclick="exportPDF()">üìÑ Division Leave Report</button>
                    <button class="btn-outline" style="color: var(--danger);" onclick="showConfirm('Are you sure you want to clear the entire local database? This cannot be undone.', resetAllData)">üóëÔ∏è Reset All Data</button>
                    <input type="file" id="restoreInput" style="display: none;" onchange="importData(this)">
                </div>
            </div>
        </div>

        <div class="directory-section">
            <div class="search-wrapper">
                <svg class="search-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <input type="text" id="searchInput" class="search-input" onkeyup="filterTable()" placeholder="Search staff by name or EPF number...">
            </div>

            <div class="table-container">
                <table id="staffTable">
                    <thead>
                        <tr>
                            <th>EPF</th>
                            <th>Staff Name</th>
                            <th style="text-align: center;">Annual</th>
                            <th style="text-align: center;">Casual</th>
                            <th style="text-align: center;">Medical</th>
                            <th style="text-align: center;">Pre-Ann</th>
                            <th style="text-align: center; background-color: #f5f3ff;">Lieu</th>
                            <th style="text-align: right;">Manage</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Custom Confirmation Modal -->
<div id="confirmModal" class="modal-overlay">
    <div class="modal-content confirm-dialog">
        <h3 id="confirmTitle" style="margin-top:0">Confirm Action</h3>
        <p id="confirmMessage" style="color: var(--secondary)">Are you sure you want to proceed?</p>
        <div class="confirm-actions">
            <button class="btn-outline" onclick="closeModal('confirmModal')">Cancel</button>
            <button id="confirmBtn" class="btn-danger">Proceed</button>
        </div>
    </div>
</div>

<!-- Leave Modal -->
<div id="leaveModal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal('leaveModal')">&times;</button>
        <div style="margin-bottom: 12px;">
            <h2 id="modalTitle" style="margin: 0; font-size: 1.5rem; color: var(--primary);">Staff Name</h2>
            <p id="modalEpf" style="margin: 4px 0 0 0; color: var(--secondary); font-weight: 600;"></p>
        </div>

        <!-- Lieu Status Breakdown -->
        <div class="lieu-summary-card">
            <div class="lieu-summary-stat">
                <h4>Lieu Earned</h4>
                <p id="modalLieuEarned">0.0</p>
            </div>
            <div class="lieu-summary-stat" style="border-left: 1px solid #ddd6fe; border-right: 1px solid #ddd6fe; padding: 0 20px;">
                <h4>Lieu Taken</h4>
                <p id="modalLieuTaken">0.0</p>
            </div>
            <div class="lieu-summary-stat">
                <h4>Available Balance</h4>
                <p id="modalLieuAvailable" style="color: #7c3aed;">0.0</p>
            </div>
        </div>

        <div style="background: #f8fafc; padding: 24px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <label style="margin: 0; font-size: 0.8rem; color: var(--primary); font-weight: 800;">Log New Leave or Holiday Work Entry</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="rangeToggle" onchange="toggleDateRange()" style="width: 18px; height: 18px; cursor: pointer;"> 
                    <label for="rangeToggle" style="margin: 0; cursor: pointer; text-transform: none; font-weight: 600;">Date Range</label>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 15px; align-items: flex-end;">
                <div>
                    <label>Action Date</label>
                    <input type="date" id="leaveDateInput">
                </div>
                <div id="toDateContainer" style="display: none;">
                    <label>To Date</label>
                    <input type="date" id="leaveToDateInput">
                </div>
                <div>
                    <label>Leave Category</label>
                    <select id="leaveTypeInput">
                        <option value="annual">Annual Leave</option>
                        <option value="casual">Casual Leave</option>
                        <option value="medical">Medical Leave</option>
                        <option value="preAnnual">Pre-Annual Leave</option>
                        <option value="short">Short Leave</option>
                        <optgroup label="Lieu Leave System">
                            <option value="lieuEarn" style="color: #5b21b6; font-weight: 700;">+ Lieu Earned (Worked Holiday)</option>
                            <option value="lieuTake" style="color: #9d174d;">- Lieu Taken (Day Off)</option>
                        </optgroup>
                    </select>
                </div>
                <div>
                    <label>Duration</label>
                    <select id="leaveValueInput">
                        <option value="1">Full Day (1.0)</option>
                        <option value="0.5">Half Day (0.5)</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="addLeaveToHistory()">+ Add Entry</button>
            </div>
            <p style="font-size: 0.65rem; color: var(--secondary); margin: 10px 0 0 0; font-style: italic;">Note: To increase Lieu balance, select "+ Lieu Earned" and enter the date(s) worked on a holiday.</p>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="font-size: 0.9rem; margin: 0; text-transform: uppercase; letter-spacing: 0.5px;">Activity History</h3>
            <div style="display: flex; gap: 10px;">
                <select id="historyMonthFilter" onchange="renderHistoryList(currentStaffId)" style="width: auto; padding: 6px 12px; font-size: 0.8rem;">
                    <option value="all">All Months</option>
                    <option value="01">January</option><option value="02">February</option><option value="03">March</option>
                    <option value="04">April</option><option value="05">May</option><option value="06">June</option>
                    <option value="07">July</option><option value="08">August</option><option value="09">September</option>
                    <option value="10">October</option><option value="11">November</option><option value="12">December</option>
                </select>
            </div>
        </div>
        
        <div id="historyListContainer" style="max-height: 250px; overflow-y: auto; padding-right: 5px;">
            <ul id="historyList" style="list-style: none; padding: 0; margin: 0;"></ul>
            <div id="noHistoryMsg" style="text-align:center; padding:40px; color: var(--secondary); font-style: italic;">No history records found.</div>
        </div>
        
        <div style="margin-top: 25px; display: flex; justify-content: flex-end;">
            <button class="btn-outline" onclick="exportStaffHistoryPDF()">üìÑ Download PDF History</button>
        </div>
    </div>
</div>

<!-- Edit Profile Modal -->
<div id="editModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 500px;">
        <button class="close-modal" onclick="closeModal('editModal')">&times;</button>
        <h2 style="margin-top: 0; color: var(--primary);">Update Staff Profile</h2>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div class="form-group">
                <label>EPF Number</label>
                <input type="text" id="editEpf" disabled style="background:#f1f5f9; font-family: monospace;">
            </div>
            <div class="form-group">
                <label>Staff Name</label>
                <input type="text" id="editName">
            </div>
            <div class="form-group">
                <label>Annual Limit</label>
                <input type="number" id="editAnnual" step="0.5">
            </div>
            <div class="form-group">
                <label>Casual Limit</label>
                <input type="number" id="editCasual" step="0.5">
            </div>
            <div class="form-group">
                <label>Medical Limit</label>
                <input type="number" id="editMedical" step="0.5">
            </div>
            <div class="form-group">
                <label>Pre-Annual Limit</label>
                <input type="number" id="editPreAnnual" step="0.5">
            </div>
        </div>
        <button class="btn-primary" onclick="saveEditStaff()">Save Changes</button>
    </div>
</div>

<script>
    let staffData = [];
    let currentStaffId = null; 
    let editStaffId = null;

    // --- Core Functions ---
    window.onload = function() {
        const stored = localStorage.getItem('idb_leave_app_v3');
        if (stored) {
            try { staffData = JSON.parse(stored); } catch(e) { staffData = []; }
        }
        renderTable();
        updateStats();
    };

    function showToast(message, type = 'primary') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.style.borderLeftColor = `var(--${type})`;
        toast.innerHTML = `<span>${message}</span>`;
        container.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    function showConfirm(msg, callback) {
        document.getElementById('confirmMessage').textContent = msg;
        const modal = document.getElementById('confirmModal');
        const btn = document.getElementById('confirmBtn');
        btn.onclick = () => {
            callback();
            closeModal('confirmModal');
        };
        modal.style.display = 'flex';
    }

    function saveData() {
        localStorage.setItem('idb_leave_app_v3', JSON.stringify(staffData));
        renderTable();
        updateStats();
        if(currentStaffId !== null) {
            renderHistoryList(currentStaffId);
            updateModalLieuSummary(currentStaffId);
        }
    }

    function getTakenCount(historyArr) {
        if (!historyArr) return 0;
        return historyArr.reduce((acc, item) => acc + (parseFloat(item.value) || 0), 0);
    }

    function updateStats() {
        let totalLeaves = 0;
        let totalLieuEarned = 0;
        let lowBalanceAlerts = [];
        
        staffData.forEach(s => {
            let lowCategories = [];
            ['annual', 'casual', 'medical', 'preAnnual'].forEach(type => {
                const limit = s.limits[type] || 0;
                const taken = getTakenCount(s.history[type]);
                const bal = limit - taken;
                totalLeaves += taken;
                if (limit > 0 && bal <= 1.5) {
                    lowCategories.push(type === 'preAnnual' ? 'Pre-Ann' : type.charAt(0).toUpperCase() + type.slice(1));
                }
            });

            const earned = getTakenCount(s.history.lieuEarn);
            const takenLieu = getTakenCount(s.history.lieuTake);
            totalLieuEarned += earned;
            const lieuBal = earned - takenLieu;
            if (earned > 0 && lieuBal < 1) {
                lowCategories.push('Lieu');
            }

            if (lowCategories.length > 0) {
                lowBalanceAlerts.push({ name: s.name, categories: lowCategories, id: s.id });
            }
        });

        document.getElementById('statStaffCount').textContent = staffData.length;
        document.getElementById('statTotalLeaves').textContent = totalLeaves.toFixed(1);
        document.getElementById('statTotalLieu').textContent = totalLieuEarned.toFixed(1);
        document.getElementById('statLowBalance').textContent = lowBalanceAlerts.length;

        const alertPanel = document.getElementById('alertsPanel');
        const alertList = document.getElementById('alertsList');
        alertList.innerHTML = '';
        
        if (lowBalanceAlerts.length > 0) {
            alertPanel.style.display = 'block';
            lowBalanceAlerts.forEach(a => {
                const div = document.createElement('div');
                div.style.cssText = 'padding:10px; border-radius:8px; background:#fff1f2; margin-bottom:8px; cursor:pointer; font-size:0.8rem; border:1px solid #fecdd3;';
                div.onclick = () => openLeaveModal(a.id);
                div.innerHTML = `<strong style="color:#991b1b">${a.name}</strong> has low <span style="font-weight:700">${a.categories.join(', ')}</span> balance.`;
                alertList.appendChild(div);
            });
        } else {
            alertPanel.style.display = 'none';
        }
    }

    function addStaff(e) {
        e.preventDefault();
        const epf = document.getElementById('epf').value.trim();
        if(staffData.some(s => s.epf === epf)) { 
            showToast("EPF Number already exists!", "danger"); 
            return; 
        }
        const newStaff = {
            id: Date.now(),
            epf: epf,
            name: document.getElementById('name').value,
            limits: {
                annual: parseFloat(document.getElementById('annualLimit').value),
                casual: parseFloat(document.getElementById('casualLimit').value),
                medical: parseFloat(document.getElementById('medicalLimit').value),
                preAnnual: parseFloat(document.getElementById('preAnnualLimit').value)
            },
            history: { 
                annual: [], casual: [], medical: [], preAnnual: [], 
                short: [], lieuEarn: [], lieuTake: [] 
            }
        };
        staffData.push(newStaff);
        document.getElementById('addStaffForm').reset();
        saveData();
        showToast("Staff profile created successfully.");
    }

    function deleteStaff(id) {
        staffData = staffData.filter(s => s.id !== id);
        saveData();
        showToast("Profile removed permanently.", "danger");
    }

    function resetAllData() {
        staffData = [];
        saveData();
        showToast("All data wiped successfully.", "danger");
    }

    function openLeaveModal(id) {
        currentStaffId = id;
        const staff = staffData.find(s => s.id === id);
        document.getElementById('modalTitle').textContent = staff.name;
        document.getElementById('modalEpf').textContent = `EPF NO: ${staff.epf}`;
        document.getElementById('leaveDateInput').valueAsDate = new Date();
        document.getElementById('leaveToDateInput').valueAsDate = new Date();
        document.getElementById('rangeToggle').checked = false;
        document.getElementById('historyMonthFilter').value = 'all';
        toggleDateRange();
        updateModalLieuSummary(id);
        renderHistoryList(id);
        document.getElementById('leaveModal').style.display = 'flex';
    }

    function updateModalLieuSummary(id) {
        const staff = staffData.find(s => s.id === id);
        const earned = getTakenCount(staff.history.lieuEarn);
        const taken = getTakenCount(staff.history.lieuTake);
        document.getElementById('modalLieuEarned').textContent = earned.toFixed(1);
        document.getElementById('modalLieuTaken').textContent = taken.toFixed(1);
        document.getElementById('modalLieuAvailable').textContent = (earned - taken).toFixed(1);
    }

    function openEditModal(id) {
        editStaffId = id;
        const staff = staffData.find(s => s.id === id);
        document.getElementById('editEpf').value = staff.epf;
        document.getElementById('editName').value = staff.name;
        document.getElementById('editAnnual').value = staff.limits.annual;
        document.getElementById('editCasual').value = staff.limits.casual;
        document.getElementById('editMedical').value = staff.limits.medical;
        document.getElementById('editPreAnnual').value = staff.limits.preAnnual || 0;
        document.getElementById('editModal').style.display = 'flex';
    }

    function saveEditStaff() {
        const staff = staffData.find(s => s.id === editStaffId);
        staff.name = document.getElementById('editName').value;
        staff.limits.annual = parseFloat(document.getElementById('editAnnual').value);
        staff.limits.casual = parseFloat(document.getElementById('editCasual').value);
        staff.limits.medical = parseFloat(document.getElementById('editMedical').value);
        staff.limits.preAnnual = parseFloat(document.getElementById('editPreAnnual').value);
        saveData();
        closeModal('editModal');
        showToast("Profile updated.");
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
        if(modalId === 'leaveModal') currentStaffId = null;
    }

    function toggleDateRange() {
        const isRange = document.getElementById('rangeToggle').checked;
        document.getElementById('toDateContainer').style.display = isRange ? 'block' : 'none';
    }

    function addLeaveToHistory() {
        const staff = staffData.find(s => s.id === currentStaffId);
        const startDateVal = document.getElementById('leaveDateInput').value;
        const endDateVal = document.getElementById('leaveToDateInput').value;
        const typeVal = document.getElementById('leaveTypeInput').value;
        const leaveVal = parseFloat(document.getElementById('leaveValueInput').value);
        const isRange = document.getElementById('rangeToggle').checked;

        if (!startDateVal) return;
        
        let datesToAdd = [];
        if (isRange) {
            let start = new Date(startDateVal);
            let end = new Date(endDateVal);
            if (end < start) { showToast("Invalid date range!", "danger"); return; }
            let current = new Date(start);
            while (current <= end) {
                datesToAdd.push(current.toISOString().split('T')[0]);
                current.setDate(current.getDate() + 1);
            }
        } else {
            datesToAdd.push(startDateVal);
        }

        const totalValueToAdd = datesToAdd.length * leaveVal;
        
        if (['annual', 'casual', 'medical', 'preAnnual'].includes(typeVal)) {
            const currentTaken = getTakenCount(staff.history[typeVal]);
            if (currentTaken + totalValueToAdd > staff.limits[typeVal]) {
                showToast(`Limit exceeded! Remaining: ${(staff.limits[typeVal] - currentTaken).toFixed(1)}`, "warning");
                return;
            }
        }

        if (typeVal === 'lieuTake') {
            const earned = getTakenCount(staff.history.lieuEarn);
            const taken = getTakenCount(staff.history.lieuTake);
            if (taken + totalValueToAdd > earned) {
                showToast(`Not enough Lieu credit! Balance: ${(earned - taken).toFixed(1)}`, "warning");
                return;
            }
        }

        if (!staff.history[typeVal]) staff.history[typeVal] = [];
        
        datesToAdd.forEach(d => {
            staff.history[typeVal].push({ date: d, value: leaveVal });
        });
        
        staff.history[typeVal].sort((a, b) => new Date(a.date) - new Date(b.date));
        saveData();
        showToast("Logged successfully.");
    }

    function deleteLeaveDate(id, type, indexInAll) {
        showConfirm("Remove this entry?", () => {
            const staff = staffData.find(s => s.id === id);
            staff.history[type].splice(indexInAll, 1);
            saveData();
            showToast("Entry removed.");
        });
    }

    function renderHistoryList(id) {
        const staff = staffData.find(s => s.id === id);
        const listEl = document.getElementById('historyList');
        const emptyMsg = document.getElementById('noHistoryMsg');
        const monthFilter = document.getElementById('historyMonthFilter').value;
        
        listEl.innerHTML = '';
        let allLeaves = [];
        Object.keys(staff.history).forEach(type => {
            if (staff.history[type]) {
                staff.history[type].forEach((item, index) => {
                    const dateStr = item.date;
                    if (monthFilter === 'all' || dateStr.split('-')[1] === monthFilter) {
                        allLeaves.push({ ...item, type, originalIndex: index });
                    }
                });
            }
        });
        
        allLeaves.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (allLeaves.length > 0) {
            emptyMsg.style.display = 'none';
            allLeaves.forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';
                
                let label, tagClass;
                switch(item.type) {
                    case 'preAnnual': label = 'Pre-Ann'; tagClass = 'tag-preAnnual'; break;
                    case 'lieuEarn': label = 'Lieu Earned (Worked)'; tagClass = 'tag-lieu-earn'; break;
                    case 'lieuTake': label = 'Lieu Taken (Leave)'; tagClass = 'tag-lieu-take'; break;
                    default: label = item.type.charAt(0).toUpperCase() + item.type.slice(1); tagClass = `tag-${item.type}`;
                }

                const valTxt = item.value === 0.5 ? '¬Ω Day' : '1 Day';
                li.innerHTML = `
                    <div>
                        <span class="tag ${tagClass}">${label}</span>
                        <strong style="margin-left:12px">${item.date}</strong>
                        <span style="color:var(--secondary); font-size:0.8rem; margin-left:8px">(${valTxt})</span>
                    </div>
                    <button style="color:var(--danger); background:none; font-size:0.75rem;" onclick="deleteLeaveDate(${id}, '${item.type}', ${item.originalIndex})">Delete</button>
                `;
                listEl.appendChild(li);
            });
        } else {
            emptyMsg.style.display = 'block';
        }
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        if(staffData.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:80px; color:var(--secondary); font-style:italic;">No staff profiles found.</td></tr>';
            return;
        }
        
        staffData.forEach(staff => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="font-family:monospace; font-weight:700; color:var(--primary)">${staff.epf}</td>
                <td style="font-weight:700;">${staff.name}</td>
                <td align="center">${formatBalanceCell(staff, 'annual')}</td>
                <td align="center">${formatBalanceCell(staff, 'casual')}</td>
                <td align="center">${formatBalanceCell(staff, 'medical')}</td>
                <td align="center">${formatBalanceCell(staff, 'preAnnual')}</td>
                <td align="center" style="background-color: #fcfaff">${formatLieuCell(staff)}</td>
                <td align="right">
                    <div style="display:flex; gap:6px; justify-content:flex-end;">
                        <button class="btn-outline" style="padding:8px" onclick="openLeaveModal(${staff.id})">üìÖ</button>
                        <button class="btn-outline" style="padding:8px" onclick="openEditModal(${staff.id})">‚úèÔ∏è</button>
                        <button class="btn-outline" style="padding:8px; color:var(--danger)" onclick="showConfirm('Delete ${staff.name}?', () => deleteStaff(${staff.id}))">üóëÔ∏è</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        filterTable();
    }

    function formatBalanceCell(staff, type) {
        const limit = staff.limits[type] || 0;
        const taken = getTakenCount(staff.history[type]);
        const bal = limit - taken;
        let statusClass = 'status-normal'; let fillClass = 'status-normal-fill';
        if (limit > 0 && bal <= 1.5) { statusClass = 'status-low'; fillClass = 'status-low-fill'; }
        else if (limit > 0 && bal > (limit/2)) { statusClass = 'status-ok'; fillClass = 'status-ok-fill'; }
        const percent = limit > 0 ? (taken / limit) * 100 : 0;
        return `
            <div class="bal-badge">
                <span class="bal-val ${statusClass}">${bal % 1 === 0 ? bal : bal.toFixed(1)}</span>
                <span class="bal-lbl">of ${limit}</span>
                <div class="progress-bg"><div class="progress-fill ${fillClass}" style="width: ${100 - percent}%"></div></div>
            </div>
        `;
    }

    function formatLieuCell(staff) {
        const earned = getTakenCount(staff.history.lieuEarn);
        const taken = getTakenCount(staff.history.lieuTake);
        const bal = earned - taken;
        const percent = earned > 0 ? (taken / earned) * 100 : 0;
        return `
            <div class="bal-badge">
                <span class="bal-val status-lieu">${bal % 1 === 0 ? bal : bal.toFixed(1)}</span>
                <span class="bal-lbl">Earn: ${earned}</span>
                <div class="progress-bg" style="background:#ddd6fe"><div class="progress-fill status-lieu-fill" style="width: ${100 - percent}%"></div></div>
            </div>
        `;
    }

    function filterTable() {
        const filter = document.getElementById("searchInput").value.toUpperCase();
        const tr = document.getElementById("tableBody").getElementsByTagName("tr");
        for (let i = 0; i < tr.length; i++) {
            const txt = tr[i].textContent || tr[i].innerText;
            tr[i].style.display = txt.toUpperCase().indexOf(filter) > -1 ? "" : "none";
        }
    }

    function backupData() {
        const blob = new Blob([JSON.stringify(staffData, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `IDB_Backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        showToast("Backup exported.");
    }

    function importData(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                staffData = JSON.parse(e.target.result);
                saveData();
                showToast("Database restored successfully.");
            } catch (err) { showToast("Invalid file format!", "danger"); }
            input.value = '';
        };
        reader.readAsText(file);
    }

    async function exportPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const year = new Date().getFullYear();
        
        doc.setFontSize(20); doc.setTextColor(15, 76, 129); doc.text("INDUSTRIAL DEVELOPMENT BOARD", 14, 20);
        doc.setFontSize(14); doc.setTextColor(100); doc.text(`Marketing Division - Staff Leave Summary ${year}`, 14, 28);
        
        const rows = staffData.map(s => [
            s.epf, s.name, 
            (s.limits.annual - getTakenCount(s.history.annual)).toFixed(1),
            (s.limits.casual - getTakenCount(s.history.casual)).toFixed(1),
            (s.limits.medical - getTakenCount(s.history.medical)).toFixed(1),
            ((s.limits.preAnnual||0) - getTakenCount(s.history.preAnnual)).toFixed(1),
            (getTakenCount(s.history.lieuEarn) - getTakenCount(s.history.lieuTake)).toFixed(1)
        ]);
        
        doc.autoTable({ 
            head: [["EPF", "Name", "Annual Bal", "Casual Bal", "Med Bal", "Pre-Ann Bal", "Lieu Bal"]], 
            body: rows, 
            startY: 35, 
            theme: 'grid', 
            headStyles: { fillColor: [15, 76, 129] } 
        });
        doc.save(`IDB_Staff_Leaves_${year}.pdf`);
    }

    async function exportStaffHistoryPDF() {
        const staff = staffData.find(s => s.id === currentStaffId);
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let historyData = [];
        Object.keys(staff.history).forEach(type => {
            if (staff.history[type]) {
                staff.history[type].forEach(item => {
                    historyData.push([item.date, type.toUpperCase(), item.value.toFixed(1)]);
                });
            }
        });
        historyData.sort((a,b) => new Date(b[0]) - new Date(a[0]));
        doc.setFontSize(18); doc.setTextColor(15, 76, 129); doc.text("INDIVIDUAL LEAVE HISTORY", 14, 20);
        doc.setFontSize(12); doc.text(`Staff Name: ${staff.name}`, 14, 30);
        doc.text(`EPF Number: ${staff.epf}`, 14, 36);
        doc.autoTable({ head: [["Date", "Type", "Days"]], body: historyData, startY: 45, headStyles: { fillColor: [15, 76, 129] } });
        doc.save(`History_${staff.epf}_${staff.name}.pdf`);
    }
</script>

</body>
</html>
